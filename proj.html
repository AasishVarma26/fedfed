<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Helping Hands - Donation Platform (All Features)</title>

<!-- Google Font -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

<!-- Chart.js for analytics -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  :root{
    --p: #ff7a3d;
    --p2:#ff5e62;
    --bg: #f6f8fb;
    --card: #ffffff;
    --muted: #6b7280;
    --success: #16a34a;
    --danger: #ef4444;
    --glass: rgba(255,255,255,0.6);
  }
  *{box-sizing:border-box}
  body{
    font-family: 'Poppins', sans-serif;
    margin:0;
    background:var(--bg);
    color:#0f172a;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    min-height:100vh;
    display:flex;
  }

  /* SIDEBAR */
  aside {
    width:250px;
    background: linear-gradient(180deg,var(--p),var(--p2));
    color:white;
    padding:24px;
    min-height:100vh;
    position:fixed;
    left:0; top:0;
  }
  aside h1{margin:0;font-size:20px; font-weight:700}
  nav{margin-top:24px}
  nav button {
    background:transparent;
    border:none;
    color:rgba(255,255,255,0.95);
    display:flex;
    align-items:center;
    gap:12px;
    padding:10px 6px;
    width:100%;
    text-align:left;
    border-radius:8px;
    cursor:pointer;
    font-weight:600;
  }
  nav button.active, nav button:hover{background:rgba(255,255,255,0.08)}

  /* MAIN */
  .main {
    margin-left:250px;
    padding:26px;
    flex:1;
  }
  header.appbar{
    display:flex;
    justify-content:space-between;
    align-items:center;
    gap:12px;
  }
  .appbar .left h2{margin:0}
  .actions{display:flex;gap:12px;align-items:center}
  .role-select, .btn {
    padding:8px 12px;
    border-radius:10px;
    border:none;
    cursor:pointer;
    background:var(--card);
    box-shadow:0 6px 18px rgba(15,23,42,0.06);
    font-weight:600;
  }
  .role-select{min-width:160px}
  .btn-primary{
    background: linear-gradient(90deg,var(--p),var(--p2));
    color:white;
  }

  /* Layout blocks */
  .grid{
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(300px,1fr));
    gap:20px;
    margin-top:20px;
  }
  .card{
    background:var(--card);
    padding:18px;
    border-radius:12px;
    box-shadow:0 6px 20px rgba(15,23,42,0.06);
  }
  .card h3{margin:0 0 12px 0;color:var(--p)}
  .muted{color:var(--muted);font-size:13px}

  /* lists */
  ul.items{list-style:none;padding:0;margin:0;display:grid;gap:10px}
  ul.items li{
    padding:12px;border-radius:10px;background:linear-gradient(180deg,rgba(255,250,247,1),#fff);
    display:flex;justify-content:space-between;align-items:center;gap:12px;border:1px solid rgba(15,23,42,0.03)
  }

  /* forms */
  .form-row{display:flex;gap:10px;margin-bottom:10px}
  input[type="text"], input[type="date"], input[type="email"], textarea, select {
    width:100%;
    padding:10px;border-radius:8px;border:1px solid #e6e9ee;background:#fff;outline:none;
  }
  textarea{min-height:80px;resize:vertical}

  /* small ui */
  .pill{padding:6px 10px;border-radius:999px;font-weight:700;font-size:13px}
  .pill.green{background:#ecfdf5;color:var(--success);border:1px solid rgba(22,163,74,0.08)}
  .pill.orange{background:#fff7ed;color:#92400e;color:var(--p)}

  /* responsive */
  @media(max-width:880px){
    aside{position:fixed;left:0;top:0;transform:translateX(0);z-index:50}
    .main{margin-left:0;padding:16px}
  }

  /* toast */
  #toast{position:fixed;right:20px;bottom:20px;z-index:9999;display:flex;flex-direction:column;gap:8px}
  .toast{background:#111827;color:white;padding:12px 16px;border-radius:10px;box-shadow:0 8px 30px rgba(2,6,23,0.4);opacity:0.98}

  /* small helpers */
  .row{display:flex;gap:12px;align-items:center}
  .ks-small{font-size:12px;color:var(--muted)}
  .linkish{color:var(--p);cursor:pointer;font-weight:700}

  /* modal (simple) */
  .modal-wrap{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(15,23,42,0.45);z-index:1000}
  .modal{background:var(--card);padding:18px;border-radius:12px;width:90%;max-width:700px;box-shadow:0 20px 60px rgba(2,6,23,0.4)}
  .modal.show{display:block}
  .flex-between{display:flex;justify-content:space-between;align-items:center}
  .small-muted{font-size:12px;color:var(--muted)}
  .table{width:100%;border-collapse:collapse}
  .table th,.table td{padding:8px;border-bottom:1px dashed rgba(15,23,42,0.04); text-align:left}
  .center{text-align:center}
</style>
</head>
<body>

<!-- Sidebar -->
<aside>
  <h1>ü§ù Helping Hands</h1>
  <p class="ks-small">Donate ‚Ä¢ Coordinate ‚Ä¢ Deliver ‚Ä¢ Track</p>

  <nav>
    <button class="nav-btn active" data-section="home">Dashboard</button>
    <button class="nav-btn" data-section="drives">Donation Drives</button>
    <button class="nav-btn" data-section="donors">Donors</button>
    <button class="nav-btn" data-section="requests">Requests</button>
    <button class="nav-btn" data-section="logistics">Logistics</button>
    <button class="nav-btn" data-section="reports">Transparency</button>
    <button class="nav-btn" data-section="settings">Settings</button>
  </nav>

  <hr style="margin:18px 0;border:none;height:1px;background:rgba(255,255,255,0.08)">
  <div style="display:flex;flex-direction:column;gap:8px">
    <div class="small-muted">Export / Import data</div>
    <div style="display:flex;gap:8px">
      <button class="btn role-select" id="exportBtn">Export</button>
      <button class="btn" id="importBtn">Import</button>
    </div>

    <div style="margin-top:12px" class="small-muted">Quick actions</div>
    <div style="display:flex;gap:8px;margin-top:8px">
      <button class="btn" id="seedBtn">Seed Sample</button>
      <button class="btn" id="clearBtn">Clear All</button>
    </div>
  </div>
</aside>

<!-- Main -->
<div class="main">
  <header class="appbar">
    <div class="left">
      <h2 id="pageTitle">Dashboard</h2>
      <div class="ks-small">Role-based multiuser donation platform</div>
    </div>

    <div class="actions">
      <select id="roleSelect" class="role-select">
        <option value="Admin">Admin</option>
        <option value="Donor">Donor</option>
        <option value="Recipient">Recipient</option>
        <option value="Logistics">Logistics Coordinator</option>
      </select>

      <button class="btn" id="openActivity">Activity Log</button>
      <button class="btn btn-primary" id="newDriveBtn">+ New Drive</button>

      <button class="btn" id="darkToggle">üåô Dark</button>
    </div>
  </header>

  <!-- Sections -->
  <!-- DASHBOARD -->
  <section id="home" class="card section active">
    <h3>Overview</h3>
    <div class="grid">
      <div class="card">
        <div class="flex-between">
          <div>
            <div class="muted">Active Drives</div>
            <div style="font-size:28px;font-weight:700" id="statDrives">0</div>
          </div>
          <div class="pill orange" id="nextDrivePill">Next: ‚Äî</div>
        </div>
        <div style="margin-top:12px" class="ks-small">Create and manage emergency drives</div>
      </div>

      <div class="card">
        <div class="flex-between">
          <div>
            <div class="muted">Total Donors</div>
            <div style="font-size:28px;font-weight:700" id="statDonors">0</div>
          </div>
          <div class="pill green" id="collectedPill">Collected: 0 items</div>
        </div>
        <div style="margin-top:12px" class="ks-small">Donor activity and summary</div>
      </div>

      <div class="card">
        <div class="flex-between">
          <div>
            <div class="muted">Open Requests</div>
            <div style="font-size:28px;font-weight:700" id="statRequests">0</div>
          </div>
          <div class="pill" id="pendingAssignPill">Unassigned: 0</div>
        </div>
        <div style="margin-top:12px" class="ks-small">Recipient requests awaiting assignment</div>
      </div>
    </div>

    <div class="grid" style="margin-top:18px">
      <div class="card">
        <h3>Donation Analytics</h3>
        <canvas id="donationChart" style="max-height:260px"></canvas>
      </div>

      <div class="card">
        <h3>Recent Activity</h3>
        <ul class="items" id="recentActivity"></ul>
      </div>
    </div>
  </section>

  <!-- DRIVES -->
  <section id="drives" class="card section" style="display:none">
    <h3>Donation Drives</h3>
    <div class="grid">
      <div class="card">
        <form id="driveForm">
          <div class="form-row">
            <input type="text" id="driveTitle" placeholder="Drive title (e.g., Flood Relief - Odisha)" required>
          </div>
          <div class="form-row">
            <input type="date" id="driveDate" required>
            <select id="driveType"><option>General</option><option>Food</option><option>Clothing</option><option>Medication</option></select>
          </div>
          <div class="form-row">
            <textarea id="driveDesc" placeholder="Describe objective and items needed"></textarea>
          </div>
          <div class="form-row">
            <button class="btn btn-primary" type="submit">Create Drive</button>
            <button class="btn" id="bulkAddDonations" type="button">Bulk Add Donor Items</button>
          </div>
        </form>
      </div>

      <div class="card">
        <h4>Active Drives</h4>
        <input type="text" id="searchDrive" placeholder="Search drives..." style="margin-bottom:10px;padding:8px;border-radius:8px;border:1px solid #e7e9ee">
        <ul class="items" id="driveList"></ul>
      </div>
    </div>
  </section>

  <!-- DONORS -->
  <section id="donors" class="card section" style="display:none">
    <h3>Donors</h3>
    <div class="grid">
      <div class="card">
        <h4>Register Donation</h4>
        <form id="donorForm">
          <input type="text" id="donorName" placeholder="Your name" required>
          <input type="email" id="donorEmail" placeholder="Email (optional)">
          <input type="text" id="donationItem" placeholder="Item or amount (e.g., 50 Meals / ‚Çπ2000 / 20 Blankets)" required>
          <select id="donationDrive">
            <option value="">Choose drive (optional)</option>
          </select>
          <div style="display:flex;gap:8px">
            <button class="btn btn-primary" type="submit">Submit Donation</button>
            <button class="btn" id="clearDonorForm" type="button">Clear</button>
          </div>
        </form>
      </div>

      <div class="card">
        <h4>Donor List</h4>
        <input type="text" id="searchDonor" placeholder="Search donors..." style="margin-bottom:10px;padding:8px;border-radius:8px;border:1px solid #e7e9ee">
        <ul class="items" id="donorList"></ul>
      </div>
    </div>
  </section>

  <!-- REQUESTS (Recipients) -->
  <section id="requests" class="card section" style="display:none">
    <h3>Recipient Requests</h3>
    <div class="grid">
      <div class="card">
        <h4>Request Items</h4>
        <form id="requestForm">
          <input type="text" id="reqName" placeholder="Recipient name" required>
          <input type="text" id="reqPhone" placeholder="Contact phone" required>
          <textarea id="reqItems" placeholder="List items needed (example: 100 meals, 40 blankets)" required></textarea>
          <input type="text" id="reqLocation" placeholder="Location / Address" required>
          <div style="display:flex;gap:8px">
            <button class="btn btn-primary" type="submit">Submit Request</button>
            <button class="btn" id="clearRequestForm" type="button">Clear</button>
          </div>
        </form>
      </div>

      <div class="card">
        <h4>Open Requests</h4>
        <input type="text" id="searchRequest" placeholder="Search requests..." style="margin-bottom:10px;padding:8px;border-radius:8px;border:1px solid #e7e9ee">
        <ul class="items" id="requestList"></ul>
      </div>
    </div>
  </section>

  <!-- LOGISTICS -->
  <section id="logistics" class="card section" style="display:none">
    <h3>Logistics Coordinator</h3>
    <div class="grid">
      <div class="card">
        <h4>Inventory</h4>
        <form id="inventoryForm">
          <input type="text" id="invItem" placeholder="Item name (e.g., Blankets)" required>
          <input type="number" id="invQty" placeholder="Quantity" required>
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn btn-primary" type="submit">Add / Update Inventory</button>
            <button class="btn" id="exportInventory" type="button">Export CSV</button>
          </div>
        </form>
        <table class="table" id="inventoryTable" style="margin-top:12px">
          <thead><tr><th>Item</th><th>Qty</th><th class="center">Action</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="card">
        <h4>Delivery Assignments</h4>
        <div class="ks-small">Assign requests to delivery and update status</div>
        <ul class="items" id="assignmentList" style="margin-top:10px"></ul>
      </div>
    </div>
  </section>

  <!-- TRANSPARENCY REPORTS -->
  <section id="reports" class="card section" style="display:none">
    <h3>Transparency & Reports</h3>
    <div class="grid">
      <div class="card">
        <h4>Post Report</h4>
        <form id="reportForm">
          <input type="text" id="reportTitle" placeholder="Title" required>
          <textarea id="reportBody" placeholder="Detailed report..." required></textarea>
          <div style="display:flex;gap:8px">
            <button class="btn btn-primary" type="submit">Post Report</button>
            <button class="btn" id="clearReport" type="button">Clear</button>
          </div>
        </form>
      </div>

      <div class="card">
        <h4>All Reports</h4>
        <ul class="items" id="reportList"></ul>
      </div>
    </div>
  </section>

  <!-- SETTINGS -->
  <section id="settings" class="card section" style="display:none">
    <h3>Settings & Admin</h3>
    <div class="grid">
      <div class="card">
        <h4>Admin Profile</h4>
        <form id="profileForm">
          <input type="text" id="adminName" placeholder="Admin name">
          <input type="email" id="adminEmail" placeholder="Email">
          <div style="display:flex;gap:8px;margin-top:8px">
            <button class="btn btn-primary" type="submit">Save Profile</button>
            <button class="btn" id="resetProfile" type="button">Reset</button>
          </div>
        </form>
      </div>

      <div class="card">
        <h4>Platform Controls</h4>
        <div style="display:flex;flex-direction:column;gap:8px">
          <button class="btn" id="bulkAssignBtn">Auto-Assign Unassigned Requests</button>
          <button class="btn" id="cleanupBtn">Remove Completed Requests (archive)</button>
          <div class="ks-small">Role is simulated locally. Export data before clearing localStorage.</div>
        </div>
      </div>
    </div>
  </section>

</div>

<!-- Toast & Modal & Activity -->
<div id="toast"></div>

<div class="modal-wrap" id="modalActivity">
  <div class="modal">
    <div class="flex-between">
      <h3>Activity Log</h3>
      <button class="btn" id="closeActivity">Close</button>
    </div>
    <div style="max-height:400px;overflow:auto;margin-top:12px">
      <ul class="items" id="activityList"></ul>
    </div>
  </div>
</div>

<!-- simple confirmation modal -->
<div class="modal-wrap" id="modalConfirm">
  <div class="modal">
    <h3 id="confirmTitle">Confirm</h3>
    <p id="confirmBody" class="small-muted">Are you sure?</p>
    <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
      <button class="btn" id="confirmNo">No</button>
      <button class="btn btn-primary" id="confirmYes">Yes</button>
    </div>
  </div>
</div>

<script>
/*
  Helping Hands - Single File App
  Data Model (stored in localStorage):
    - drives: [{id,title,date,type,desc,createdAt}]
    - donors: [{id,name,email,gift,driveId,createdAt}]
    - requests: [{id,name,phone,items,location,status,assignedTo,createdAt,feedback}]
    - inventory: [{item,qty}]
    - reports: [{id,title,body,createdAt}]
    - activity: [{ts,role,action,meta}]
    - profile: {name,email}
*/

const STORE_KEYS = {
  drives:'hh_drives',
  donors:'hh_donors',
  requests:'hh_requests',
  inventory:'hh_inventory',
  reports:'hh_reports',
  activity:'hh_activity',
  profile:'hh_profile'
};

function uid(prefix='id'){ return prefix + '_' + Math.random().toString(36).slice(2,9); }
function now(){ return new Date().toISOString(); }
function save(key, val){ localStorage.setItem(key, JSON.stringify(val)); }
function load(key, fallback=[]){ try { const v = JSON.parse(localStorage.getItem(key)); return v || fallback } catch(e){ return fallback; } }
function toast(msg, t=3000){ const node=document.createElement('div'); node.className='toast'; node.textContent=msg; document.getElementById('toast').appendChild(node); setTimeout(()=>node.remove(), t); }

// seed sample data
function seedData(){
  const drives = [
    { id:uid('drive'), title:'Flood Relief - Coastal A', date:'2025-10-05', type:'Food', desc:'Emergency food packs', createdAt:now() },
    { id:uid('drive'), title:'Winter Clothing Drive - North', date:'2025-11-20', type:'Clothing', desc:'Warm blankets & jackets', createdAt:now() }
  ];
  const donors = [
    { id:uid('don'), name:'Ramesh', email:'ramesh@example.com', gift:'50 Meals', driveId:drives[0].id, createdAt:now() },
    { id:uid('don'), name:'Ananya', email:'ananya@example.com', gift:'‚Çπ5000', driveId:drives[0].id, createdAt:now() },
    { id:uid('don'), name:'Mohan', email:'mohan@example.com', gift:'20 Blankets', driveId:drives[1].id, createdAt:now() }
  ];
  const requests = [
    { id:uid('req'), name:'Village Council A', phone:'+91-9876543210', items:'200 Meals, 100 Water Bottles', location:'Coastal A', status:'open', assignedTo:null, createdAt:now(), feedback:'' },
    { id:uid('req'), name:'Orphanage B', phone:'+91-9123456780', items:'50 Blankets', location:'North Town', status:'open', assignedTo:null, createdAt:now(), feedback:'' }
  ];
  const inventory = [
    { item:'Meals', qty:500 }, { item:'Blankets', qty:80 }, { item:'Water Bottles', qty:600 }
  ];
  const reports = [
    { id:uid('rep'), title:'Initial collection', body:'Collected 200 meals for coastal relief.', createdAt:now() }
  ];
  const activity = [
    { ts:now(), role:'system', action:'seed', meta:{info:'sample data seeded'} }
  ];
  save(STORE_KEYS.drives, drives);
  save(STORE_KEYS.donors, donors);
  save(STORE_KEYS.requests, requests);
  save(STORE_KEYS.inventory, inventory);
  save(STORE_KEYS.reports, reports);
  save(STORE_KEYS.activity, activity);
  save(STORE_KEYS.profile, { name:'Admin', email:'admin@helpinghands.org' });
  refreshUI();
  toast('Sample data seeded');
}

// clear all
function clearAll(){
  if(!confirm('Clear all local data? This cannot be undone unless you exported.')) return;
  Object.values(STORE_KEYS).forEach(k=>localStorage.removeItem(k));
  refreshUI();
  toast('All data cleared');
}

/* ------------- Activity logging ------------- */
function logActivity(role, action, meta){
  const arr = load(STORE_KEYS.activity, []);
  arr.unshift({ ts:now(), role, action, meta });
  // trim to 200
  if(arr.length>200) arr.length=200;
  save(STORE_KEYS.activity, arr);
  renderActivity();
}

/* ------------- Dashboard / Chart ------------- */
let donationChart = null;
function renderDashboard(){
  const drives = load(STORE_KEYS.drives, []);
  const donors = load(STORE_KEYS.donors, []);
  const requests = load(STORE_KEYS.requests, []);
  const reports = load(STORE_KEYS.reports, []);
  const inventory = load(STORE_KEYS.inventory, []);

  document.getElementById('statDrives').textContent = drives.length;
  document.getElementById('statDonors').textContent = donors.length;
  document.getElementById('statRequests').textContent = requests.filter(r=>r.status!=='completed').length;
  document.getElementById('reportCount') && (document.getElementById('reportCount').textContent = reports.length);
  document.getElementById('collectedPill').textContent = `Collected: ${donors.length} donations`;

  // next drive pill
  const upcoming = drives.filter(d=>d.date).sort((a,b)=>new Date(a.date)-new Date(b.date))[0];
  document.getElementById('nextDrivePill').textContent = upcoming ? `Next: ${upcoming.title} (${upcoming.date})` : 'Next: ‚Äî';

  // pending assign
  const unassigned = requests.filter(r=>r.status==='open' && !r.assignedTo).length;
  document.getElementById('pendingAssignPill').textContent = `Unassigned: ${unassigned}`;

  // donation chart: group by type or drives values (simple counts)
  const byType = donors.reduce((acc, d) => {
    // crude: if gift contains 'Blanket' or 'Meals' or currency
    let k = 'Other';
    const g = (d.gift||'').toLowerCase();
    if(/meal/.test(g)) k='Meals';
    else if(/blanket|jacket|clothing/.test(g)) k='Clothing';
    else if(/‚Çπ|\$|rs|inr/.test(g)) k='Monetary';
    else if(/water|bottle/.test(g)) k='Water';
    acc[k] = (acc[k]||0)+1; return acc;
  }, {});
  const labels = Object.keys(byType);
  const data = Object.values(byType);
  const ctx = document.getElementById('donationChart').getContext('2d');
  if(donationChart) donationChart.destroy();
  donationChart = new Chart(ctx, {
    type:'pie',
    data:{ labels, datasets:[{ data, backgroundColor:['#ff7a3d','#ffb199','#ffd9cc','#ff5e62'] }] },
    options:{ responsive:true, plugins:{legend:{position:'bottom'}} }
  });

  // recent activity
  renderRecentActivity();
}

/* ------------- Drives ------------- */
function renderDrivesList(filter=''){
  const list = load(STORE_KEYS.drives, []);
  const container = document.getElementById('driveList');
  container.innerHTML='';
  const f = filter.trim().toLowerCase();
  list.filter(d => !f || (d.title + ' ' + d.desc + ' ' + d.type).toLowerCase().includes(f))
    .sort((a,b)=> new Date(b.createdAt) - new Date(a.createdAt))
    .forEach(d => {
      const li = document.createElement('li');
      li.innerHTML = `<div>
        <div style="font-weight:700">${escapeHTML(d.title)}</div>
        <div class="ks-small">${escapeHTML(d.type)} ‚Ä¢ ${d.date || 'No date'}</div>
        <div class="small-muted ks-small" style="margin-top:6px">${escapeHTML(d.desc)}</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
        <button class="btn" onclick="editDrive('${d.id}')">Edit</button>
        <button class="btn" onclick="deleteDrive('${d.id}')">Delete</button>
      </div>`;
      container.appendChild(li);
    });
}

function createDrive(obj){
  const arr = load(STORE_KEYS.drives, []);
  arr.push({...obj, id:uid('drive'), createdAt:now()});
  save(STORE_KEYS.drives, arr);
  logActivity(getRole(),'create-drive',obj);
  renderDrivesList();
  renderDashboard();
  toast('Drive created');
}
function editDrive(id){
  const drives = load(STORE_KEYS.drives, []);
  const d = drives.find(x=>x.id===id);
  if(!d) return;
  // quick prompt editing (for brevity)
  const newTitle = prompt('Edit drive title', d.title);
  if(newTitle===null) return;
  d.title = newTitle || d.title;
  save(STORE_KEYS.drives, drives);
  logActivity(getRole(),'edit-drive',{id});
  renderDrivesList(); renderDashboard(); toast('Drive updated');
}
function deleteDrive(id){
  confirmModal('Delete drive', 'Remove this drive? This will not remove associated donations.', ()=>{
    let arr = load(STORE_KEYS.drives, []);
    arr = arr.filter(x=>x.id!==id);
    save(STORE_KEYS.drives, arr);
    logActivity(getRole(),'delete-drive',{id});
    renderDrivesList(); renderDashboard(); toast('Drive deleted');
  });
}

/* ------------- Donors ------------- */
function renderDonorsList(filter=''){
  const list = load(STORE_KEYS.donors, []);
  const container = document.getElementById('donorList');
  container.innerHTML='';
  const f = filter.trim().toLowerCase();
  list.filter(d => !f || (d.name + ' ' + d.gift + ' ' + (d.email||'')).toLowerCase().includes(f))
    .sort((a,b)=> new Date(b.createdAt) - new Date(a.createdAt))
    .forEach(d => {
      const drive = getDriveById(d.driveId);
      const li = document.createElement('li');
      li.innerHTML = `<div>
        <div style="font-weight:700">${escapeHTML(d.name)} ${d.email?'<span class="small-muted">('+escapeHTML(d.email)+')</span>':''}</div>
        <div class="ks-small">${escapeHTML(d.gift)} ${drive?`‚Ä¢ <span class="small-muted">${escapeHTML(drive.title)}</span>`:''}</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
        <button class="btn" onclick="viewDonor('${d.id}')">View</button>
        <button class="btn" onclick="removeDonor('${d.id}')" style="background:#fff;border:1px solid #eee">Remove</button>
      </div>`;
      container.appendChild(li);
    });
  document.getElementById('statDonors').textContent = list.length;
}
function registerDonation(obj){
  const arr = load(STORE_KEYS.donors, []);
  arr.push({...obj, id:uid('don'), createdAt:now()});
  save(STORE_KEYS.donors, arr);
  logActivity(getRole(),'donation',obj);
  renderDonorsList();
  renderDashboard();
  toast('Donation recorded ‚Äî thank you!');
}
function viewDonor(id){
  const donor = load(STORE_KEYS.donors,[]).find(d=>d.id===id);
  if(!donor){ toast('Donor not found'); return; }
  alert(`Donor: ${donor.name}\nEmail: ${donor.email||'‚Äî'}\nGift: ${donor.gift}\nDrive: ${getDriveById(donor.driveId)?.title || '‚Äî'}\nCreated: ${donor.createdAt}`);
}
function removeDonor(id){
  confirmModal('Remove donor', 'Remove donor record?', ()=>{
    let arr = load(STORE_KEYS.donors, []);
    arr = arr.filter(x=>x.id!==id); save(STORE_KEYS.donors, arr);
    logActivity(getRole(),'remove-donor',{id}); renderDonorsList(); renderDashboard(); toast('Donor removed');
  });
}

/* ------------- Requests (Recipients) ------------- */
function renderRequestList(filter=''){
  const list = load(STORE_KEYS.requests, []);
  const container = document.getElementById('requestList');
  container.innerHTML='';
  const f = filter.trim().toLowerCase();
  list.filter(r => !f || (r.name + ' ' + r.items + ' ' + r.location).toLowerCase().includes(f))
    .sort((a,b)=> new Date(b.createdAt) - new Date(a.createdAt))
    .forEach(r=>{
      const li = document.createElement('li');
      const assigned = r.assignedTo ? `<div class="ks-small">Assigned to: <strong>${escapeHTML(r.assignedTo)}</strong></div>` : '<div class="ks-small">Unassigned</div>';
      li.innerHTML = `<div>
          <div style="font-weight:700">${escapeHTML(r.name)}</div>
          <div class="ks-small">${escapeHTML(r.items)} ‚Ä¢ ${escapeHTML(r.location)}</div>
          ${assigned}
          <div class="small-muted ks-small">${r.status} ‚Ä¢ ${r.createdAt.split('T')[0]}</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:6px">
        <button class="btn" onclick="viewRequest('${r.id}')">Details</button>
        <button class="btn" onclick="assignRequestPrompt('${r.id}')">Assign</button>
      </div>`;
      container.appendChild(li);
    });
  document.getElementById('statRequests').textContent = list.filter(r=>r.status!=='completed').length;
}

function createRequest(obj){
  const arr = load(STORE_KEYS.requests, []);
  arr.push({...obj, id:uid('req'), status:'open', assignedTo:null, createdAt:now(), feedback:''});
  save(STORE_KEYS.requests, arr);
  logActivity(getRole(),'create-request',obj);
  renderRequestList(); renderDashboard();
  toast('Request submitted ‚Äî we will respond soon');
}

function viewRequest(id){
  const r = load(STORE_KEYS.requests,[]).find(x=>x.id===id);
  if(!r) return toast('Request not found');
  const txt = `Request by: ${r.name}\nPhone: ${r.phone}\nItems: ${r.items}\nLocation: ${r.location}\nStatus: ${r.status}\nAssigned: ${r.assignedTo || '‚Äî'}\nFeedback: ${r.feedback || '‚Äî'}`;
  alert(txt);
}

/* assignment by logistics/admin */
function assignRequestPrompt(id){
  const r = load(STORE_KEYS.requests,[]).find(x=>x.id===id);
  if(!r) return toast('Request not found');
  const driver = prompt('Assign to (enter coordinator name or vehicle id):', r.assignedTo || '');
  if(driver === null) return;
  r.assignedTo = driver || null;
  r.status = driver ? 'assigned' : r.status;
  const arr = load(STORE_KEYS.requests,[]).map(x=> x.id===id ? r : x);
  save(STORE_KEYS.requests, arr);
  logActivity(getRole(),'assign-request',{id,assignedTo:driver});
  renderRequestList(); renderAssignments(); renderDashboard();
  toast(driver ? 'Assigned' : 'Unassigned');
}

/* complete / update delivery status (logistics) */
function updateRequestStatus(id, status){
  const arr = load(STORE_KEYS.requests,[]);
  const idx = arr.findIndex(x=>x.id===id);
  if(idx === -1) return;
  arr[idx].status = status;
  if(status==='completed') arr[idx].completedAt = now();
  save(STORE_KEYS.requests, arr);
  logActivity(getRole(),'update-request',{id,status});
  renderRequestList(); renderAssignments(); renderDashboard();
  toast('Request status updated');
}

/* ------------- Logistics / Inventory ------------- */
function renderInventory(){
  const inv = load(STORE_KEYS.inventory, []);
  const tbody = document.querySelector('#inventoryTable tbody');
  tbody.innerHTML = '';
  inv.forEach(it=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${escapeHTML(it.item)}</td><td>${it.qty}</td><td class="center">
      <button class="btn" onclick="decrInv('${it.item}')">-</button>
      <button class="btn" onclick="incrInv('${it.item}')">+</button>
      <button class="btn" onclick="removeInv('${it.item}')">Remove</button>
    </td>`;
    tbody.appendChild(tr);
  });
}

function addInventory(item, qty){
  item = item.trim();
  if(!item || !qty) return;
  const inv = load(STORE_KEYS.inventory, []);
  const existing = inv.find(i=>i.item.toLowerCase()===item.toLowerCase());
  if(existing){ existing.qty += Number(qty); }
  else { inv.push({ item, qty: Number(qty) }); }
  save(STORE_KEYS.inventory, inv);
  renderInventory();
  logActivity(getRole(),'update-inventory',{item,qty});
  toast('Inventory updated');
}

function incrInv(item){
  const inv = load(STORE_KEYS.inventory, []);
  const it = inv.find(i=>i.item===item);
  if(it){ it.qty += 1; save(STORE_KEYS.inventory, inv); renderInventory(); }
}
function decrInv(item){
  const inv = load(STORE_KEYS.inventory, []);
  const it = inv.find(i=>i.item===item);
  if(it && it.qty>0){ it.qty -= 1; save(STORE_KEYS.inventory, inv); renderInventory(); }
}
function removeInv(item){
  confirmModal('Remove inventory', `Remove ${item} from inventory?`, ()=>{
    let inv = load(STORE_KEYS.inventory, []);
    inv = inv.filter(i=>i.item!==item); save(STORE_KEYS.inventory, inv);
    renderInventory(); toast('Item removed');
  });
}

/* ------------- Assignments list (logistics) ------------- */
function renderAssignments(){
  const requests = load(STORE_KEYS.requests, []);
  const container = document.getElementById('assignmentList');
  container.innerHTML = '';
  requests.filter(r=>r.assignedTo).forEach(r=>{
    const li = document.createElement('li');
    li.innerHTML = `<div>
      <div style="font-weight:700">${escapeHTML(r.name)} ‚Ä¢ ${escapeHTML(r.location)}</div>
      <div class="ks-small">${escapeHTML(r.items)}</div>
      <div class="small-muted ks-small">Status: ${r.status}</div>
    </div>
    <div style="display:flex;flex-direction:column;gap:6px">
      <button class="btn" onclick="updateRequestStatus('${r.id}','in-transit')">Mark In-Transit</button>
      <button class="btn" onclick="updateRequestStatus('${r.id}','completed')">Mark Delivered</button>
    </div>`;
    container.appendChild(li);
  });
}

/* ------------- Reports ------------- */
function renderReports(){
  const r = load(STORE_KEYS.reports, []);
  const container = document.getElementById('reportList');
  container.innerHTML = '';
  r.sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt)).forEach(rep=>{
    const li = document.createElement('li');
    li.innerHTML = `<div>
      <div style="font-weight:700">${escapeHTML(rep.title)}</div>
      <div class="ks-small">${escapeHTML(rep.body)}</div>
      <div class="small-muted ks-small">${rep.createdAt.split('T')[0]}</div>
    </div>
    <div><button class="btn" onclick="viewReport('${rep.id}')">View</button></div>`;
    container.appendChild(li);
  });
}
function createReport(title, body){
  const arr = load(STORE_KEYS.reports, []);
  arr.push({ id:uid('rep'), title, body, createdAt:now() });
  save(STORE_KEYS.reports, arr);
  logActivity(getRole(),'post-report',{title});
  renderReports(); renderDashboard();
  toast('Report posted');
}
function viewReport(id){
  const r = load(STORE_KEYS.reports,[]).find(x=>x.id===id);
  if(!r) return toast('Report not found');
  alert(`${r.title}\n\n${r.body}\n\nPosted: ${r.createdAt}`);
}

/* ------------- Activity rendering ------------- */
function renderActivity(){
  const arr = load(STORE_KEYS.activity, []);
  const list = document.getElementById('activityList');
  list.innerHTML = '';
  arr.forEach(a=>{
    const li = document.createElement('li');
    li.innerHTML = `<div><div style="font-weight:700">${escapeHTML(a.action)}</div><div class="small-muted ks-small">${a.ts} ‚Ä¢ ${escapeHTML(a.role)}</div></div><div>${JSON.stringify(a.meta||{})}</div>`;
    list.appendChild(li);
  });
}
function renderRecentActivity(){
  const arr = load(STORE_KEYS.activity, []).slice(0,6);
  const container = document.getElementById('recentActivity');
  container.innerHTML='';
  arr.forEach(a=>{
    const li = document.createElement('li');
    li.innerHTML = `<div><div style="font-weight:700">${escapeHTML(a.action)}</div><div class="ks-small">${a.ts.split('T')[0]} ‚Ä¢ ${escapeHTML(a.role)}</div></div>`;
    container.appendChild(li);
  });
}

/* ------------- Helpers & Utilities ------------- */
function getDriveById(id){ return load(STORE_KEYS.drives,[]).find(d=>d.id===id) }
function escapeHTML(s=''){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;') }

function confirmModal(title, body, yesCb){
  document.getElementById('confirmTitle').textContent = title;
  document.getElementById('confirmBody').textContent = body;
  const wrap = document.getElementById('modalConfirm');
  wrap.style.display='flex';
  const yes = document.getElementById('confirmYes'), no = document.getElementById('confirmNo');
  function cleanup(){ wrap.style.display='none'; yes.removeEventListener('click',onYes); no.removeEventListener('click',onNo) }
  function onYes(){ cleanup(); yesCb && yesCb(); }
  function onNo(){ cleanup(); }
  yes.addEventListener('click', onYes);
  no.addEventListener('click', onNo);
}

/* ------------- Role management (simulated auth) ------------- */
function getRole(){ return document.getElementById('roleSelect').value }
document.getElementById('roleSelect').addEventListener('change', ()=> {
  const r = getRole();
  logActivity(r, 'switch-role', {role:r});
  renderForRole(r);
});

/* ------------- Render for Role ------------- */
function renderForRole(role){
  // which nav button should be active? we map roles to starting page
  const map = { Admin:'home', Donor:'donors', Recipient:'requests', Logistics:'logistics' };
  const target = map[role] || 'home';
  showSection(target);
  toast(`Switched to ${role} view`);
}

/* ------------- Page navigation (single page) ------------- */
document.querySelectorAll('.nav-btn').forEach(btn=>{
  btn.addEventListener('click', (e)=>{
    document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    showSection(btn.dataset.section);
  });
});
function showSection(id){
  document.querySelectorAll('.section').forEach(s=>s.style.display='none');
  const sec = document.getElementById(id);
  if(sec) sec.style.display='block';
  document.getElementById('pageTitle').textContent = id.charAt(0).toUpperCase() + id.slice(1);
}

/* ------------- Export / Import ------------- */
document.getElementById('exportBtn').addEventListener('click', ()=>{
  const exportObj = {};
  Object.values(STORE_KEYS).forEach(k => { exportObj[k] = load(k,[]); });
  const blob = new Blob([JSON.stringify(exportObj,null,2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download = 'helping-hands-export.json'; a.click();
  URL.revokeObjectURL(url);
  toast('Export started');
});
document.getElementById('importBtn').addEventListener('click', ()=>{
  const input = document.createElement('input'); input.type='file'; input.accept='.json,application/json';
  input.onchange = e=>{
    const f = e.target.files[0]; if(!f) return;
    const reader = new FileReader();
    reader.onload = ev=>{
      try{
        const parsed = JSON.parse(ev.target.result);
        Object.keys(parsed).forEach(k=>{
          // only accept known keys
          if(Object.values(STORE_KEYS).includes(k)) save(k, parsed[k]);
        });
        toast('Import complete'); refreshUI();
      }catch(err){ toast('Invalid JSON'); }
    };
    reader.readAsText(f);
  };
  input.click();
});

/* ------------- Event wiring for forms & UI actions ------------- */
document.getElementById('driveForm').addEventListener('submit', e=>{
  e.preventDefault();
  const title = document.getElementById('driveTitle').value.trim();
  const date = document.getElementById('driveDate').value;
  const type = document.getElementById('driveType').value;
  const desc = document.getElementById('driveDesc').value.trim();
  if(!title) return toast('Drive title required');
  createDrive({ title, date, type, desc });
  document.getElementById('driveForm').reset();
  populateDriveSelects();
});

document.getElementById('bulkAddDonations').addEventListener('click', ()=>{
  // quick demo: add random donor entries to selected drive
  const drives = load(STORE_KEYS.drives, []);
  if(!drives.length) return toast('No drives to add to');
  const d = drives[0];
  const donors=load(STORE_KEYS.donors,[]);
  donors.push(...[
    {id:uid('don'),name:'Bulk Donor A',email:'a@example.com',gift:'100 Meals',driveId:d.id,createdAt:now()},
    {id:uid('don'),name:'Bulk Donor B',email:'b@example.com',gift:'50 Blankets',driveId:d.id,createdAt:now()}
  ]);
  save(STORE_KEYS.donors, donors);
  renderDonorsList(); renderDashboard(); toast('Bulk donors added');
});

document.getElementById('searchDrive').addEventListener('input', e=> renderDrivesList(e.target.value) );
document.getElementById('donorForm').addEventListener('submit', e=>{
  e.preventDefault();
  const name = document.getElementById('donorName').value.trim();
  const email = document.getElementById('donorEmail').value.trim();
  const gift = document.getElementById('donationItem').value.trim();
  const driveId = document.getElementById('donationDrive').value || null;
  if(!name||!gift) return toast('Name & donation required');
  registerDonation({ name, email, gift, driveId });
  document.getElementById('donorForm').reset();
});
document.getElementById('searchDonor').addEventListener('input', e=> renderDonorsList(e.target.value));

document.getElementById('requestForm').addEventListener('submit', e=>{
  e.preventDefault();
  const name=document.getElementById('reqName').value.trim();
  const phone=document.getElementById('reqPhone').value.trim();
  const items=document.getElementById('reqItems').value.trim();
  const location=document.getElementById('reqLocation').value.trim();
  if(!name||!phone||!items) return toast('Please fill required fields');
  createRequest({ name, phone, items, location });
  document.getElementById('requestForm').reset();
});
document.getElementById('searchRequest').addEventListener('input', e=> renderRequestList(e.target.value));

document.getElementById('inventoryForm').addEventListener('submit', e=>{
  e.preventDefault();
  const item = document.getElementById('invItem').value.trim();
  const qty = Number(document.getElementById('invQty').value);
  if(!item||!qty) return toast('Item & qty required');
  addInventory(item, qty);
  document.getElementById('inventoryForm').reset();
});
document.getElementById('exportInventory').addEventListener('click', ()=>{
  const inv = load(STORE_KEYS.inventory, []);
  let csv = 'Item,Qty\n' + inv.map(i=>`${i.item},${i.qty}`).join('\n');
  const blob = new Blob([csv], {type:'text/csv'}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;a.download='inventory.csv';a.click();URL.revokeObjectURL(url);
});

document.getElementById('reportForm').addEventListener('submit', e=>{
  e.preventDefault();
  const t=document.getElementById('reportTitle').value.trim();
  const b=document.getElementById('reportBody').value.trim();
  if(!t||!b) return toast('Title & body required');
  createReport(t,b); document.getElementById('reportForm').reset();
});
document.getElementById('clearReport').addEventListener('click', ()=> document.getElementById('reportForm').reset() );

document.getElementById('profileForm').addEventListener('submit', e=>{
  e.preventDefault();
  const p = { name: document.getElementById('adminName').value.trim(), email: document.getElementById('adminEmail').value.trim() };
  save(STORE_KEYS.profile, p); toast('Profile saved'); logActivity(getRole(),'save-profile',p);
});
document.getElementById('resetProfile').addEventListener('click', ()=> { save(STORE_KEYS.profile, {}); document.getElementById('profileForm').reset(); toast('Profile reset')});

document.getElementById('bulkAssignBtn').addEventListener('click', ()=>{
  // auto-assign open unassigned requests to 'AutoCoordinator'
  const arr = load(STORE_KEYS.requests, []);
  let changed=false;
  arr.forEach(r=>{ if(r.status==='open' && !r.assignedTo){ r.assignedTo='AutoCoordinator'; r.status='assigned'; changed=true; } });
  if(changed){ save(STORE_KEYS.requests, arr); logActivity(getRole(),'bulk-assign',{}); renderRequestList(); renderAssignments(); toast('Auto-assigned') } else toast('No unassigned open requests');
});

document.getElementById('cleanupBtn').addEventListener('click', ()=>{
  confirmModal('Archive completed', 'Move completed requests to archive? (this demo just removes them)', ()=>{
    let arr = load(STORE_KEYS.requests, []);
    arr = arr.filter(r=>r.status!=='completed');
    save(STORE_KEYS.requests, arr);
    logActivity(getRole(),'cleanup-completed',{}); renderRequestList(); renderAssignments(); toast('Completed requests removed');
  });
});

document.getElementById('newDriveBtn').addEventListener('click', ()=> showSection('drives'));

document.getElementById('openActivity').addEventListener('click', ()=> {
  document.getElementById('modalActivity').style.display='flex';
});
document.getElementById('closeActivity').addEventListener('click', ()=> document.getElementById('modalActivity').style.display='none');
document.getElementById('seedBtn').addEventListener('click', seedData);
document.getElementById('clearBtn').addEventListener('click', clearAll);

/* confirm modal close when clicking outside */
document.querySelectorAll('.modal-wrap').forEach(m=>{
  m.addEventListener('click', (e)=>{ if(e.target===m) m.style.display='none' });
});

document.getElementById('darkToggle').addEventListener('click', ()=>{
  document.body.classList.toggle('dark');
  document.getElementById('darkToggle').textContent = document.body.classList.contains('dark') ? '‚òÄÔ∏è Light' : 'üåô Dark';
});

/* modal confirm Yes/No handled in confirmModal above */

/* quick remove all entries button */
document.getElementById('clearDonorForm').addEventListener('click', ()=> document.getElementById('donorForm').reset());
document.getElementById('clearRequestForm').addEventListener('click', ()=> document.getElementById('requestForm').reset());

/* inventory helpers wired earlier */

/* remove all completed requests (ref) - accessed via settings cleanup */

/* ------------- UI refresh / boot ------------- */
function populateDriveSelects(){
  const drives = load(STORE_KEYS.drives, []);
  const sel = document.getElementById('donationDrive');
  sel.innerHTML = '<option value="">Choose drive (optional)</option>';
  drives.forEach(d=> sel.innerHTML += `<option value="${d.id}">${escapeHTML(d.title)}</option>`);
}
function refreshUI(){
  populateDriveSelects();
  renderDrivesList();
  renderDonorsList();
  renderRequestList();
  renderInventory();
  renderAssignments();
  renderReports();
  renderDashboard();
  renderActivity();
  // load profile
  const p = load(STORE_KEYS.profile, {});
  if(p.name) document.getElementById('adminName').value = p.name;
  if(p.email) document.getElementById('adminEmail').value = p.email;
}
refreshUI();

/* simple confirm delete of all via clear button was wired above */

/* utility: export small sample */
document.getElementById('exportBtn').addEventListener('click', ()=> logActivity(getRole(),'export-data',{}));

/* helpers: remove donor or drive invoked earlier */

/* keyboard shortcut: press 's' to open seed for demo */
window.addEventListener('keydown', (e)=>{ if(e.key==='s') seedData(); });

/* small safety: if no data exists, seed minimal sample to make UI non-empty */
if(!localStorage.getItem(STORE_KEYS.drives) && !localStorage.getItem(STORE_KEYS.donors) && !localStorage.getItem(STORE_KEYS.requests)){
  seedData();
}

/* small helper display */
renderRecentActivity();

/* simple CSV export already implemented */

</script>
</body>
</html>
